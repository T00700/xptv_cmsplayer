#!name=Emby Plugin
#!desc=Emby 官方客戶端內調用外部播放器，Web新增下載選項
# 原作者 @renzhipengBot, @AppleArcade
# 此版本僅做學習用途
# 1. Emby 官方 iOS/macOS 客戶端播放權限解鎖；2. 瀏覽器中下載影片或外掛字幕 ( 如果影片有外掛字幕且選中，則下載外掛字幕文件，否則下載影片文件 )、使用 Shu 下載 ( 如果影片有外掛字幕，則下載全部外掛字幕 )、使用 iOS 版 VLC 下載 ( 如果影片有外掛字幕且選中，則下載外掛字幕文件，否則下載影片文件 )、使用 iOS 版 nPlayer 播放 ( 不支持外掛字幕 )、使用 VLC 播放 ( 支持選中的外掛字幕 )、使用 iOS 和 macOS 版 Infuse 播放 ( 不支持外掛字幕 )。
# 地址是 HTTPS 的Emby server，需自行在 MitM 里添加域名。Surge 需要開啓 「用於 TCP 連接」 的 HTTPS 解密。Surge macOS 需開啓 「增強模式」。

[Script]
[Emby]播放解鎖 = type=http-response,pattern=^https?:\/\/mb3admin.com\/admin\/service\/registration\/validateDevice,requires-body=true,max-size=0,script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/unlock.js,debug=false
[Emby]添加外部播放器連接 = type=http-response,pattern=\/Users\/\w{32}\/Items\/\d+\?,requires-body=true,max-size=0,script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/emby_plugin.js,debug=false
[Emby]打開外部播放器 = type=http-response,pattern=\/plugin\/scheme,script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/emby_plugin.js,debug=false
[Emby]資源路徑偽靜態 = type=http-request,pattern=(\/Videos\/\d+\/stream\/.+\?.+&filename)|(\/Videos\/\d+\/\w{32}\/Subtitles\/\d+\/.+\?.+&filename),script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/emby_plugin.js,debug=false
[Emby]影片下載 = type=http-response,pattern=((\/emby)*\/Users\/\w{32}\/Items\/\d+\?)|((\/emby)*\/Items\/\d+\/Download)|(\/web\/modules\/itemcontextmenu\.js)|(\/web\/item\/item\.js),requires-body=true,max-size=0,script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/emby_download.js,debug=false
[Emby]請求路徑重命名 = type=http-request,pattern=(\/Videos\/\d+\/stream\/.+\?.+&filename)|(\/Videos\/\d+\/\w{32}\/Subtitles\/\d+\/.+\?.+&filename),script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/download_path_rename.js,debug=false
[Emby]下載文件重命名 = type=http-response,pattern=(\/Videos\/\d+\/stream\?.+&filename)|(\/Videos\/\d+\/\w{32}\/Subtitles\/.+&filename),requires-body=false,max-size=0,script-path=https://raw.githubusercontent.com/Yswag/for-own-use/main/js/Emby/download_file_rename.js,debug=false

[MITM]
hostname = %APPEND% mb3admin.com, *.plusmedia.site:0